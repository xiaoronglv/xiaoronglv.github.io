---
title: "Rails éƒ¨ç½²ç®¡ç†"
layout: post
guid: XKPa1KmnJCcD
date: 2022-08-12
coffee:
tags:
  -
---

å½“ä½¿ç”¨å‘½ä»¤è¡Œ `rails new` å»åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®æ—¶ï¼ŒRails é»˜è®¤ä¼šåˆ›å»ºä¸‰ä¸ªç¯å¢ƒï¼š

- development: æœ¬åœ°å¼€å‘ç¯å¢ƒã€‚
- test: ç”¨æ¥è·‘æµ‹è¯•ã€‚
- production: ç”Ÿäº§ç¯å¢ƒï¼Œç”¨æ¥æœåŠ¡å®¢æˆ·ã€‚

åœ¨é¡¹ç›®çš„æœ€æ—©æœŸï¼Œè¿˜å¤„äºéªŒè¯æƒ³æ³•é˜¶æ®µã€‚å·¥ç¨‹å¸ˆçš„å·¥ä½œæµç¨‹ä¹Ÿæ¯”è¾ƒç²—ç‹‚ï¼Œå†™ä»£ç ï¼Œè·‘æµ‹è¯•ï¼Œç„¶åç›´æ¥éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒã€‚

## ä¸šåŠ¡çš„ç¬¬ä¸€é˜¶æ®µï¼šå°‘é‡å®¢æˆ·é˜¶æ®µ

äº§å“ä¸æ–­è¿­ä»£ï¼Œé€æ¸çš„æœ‰å®¢æˆ·å¼€å§‹ä½¿ç”¨äº§å“ã€‚ä¸ºäº†ä¿è¯å·¥ç¨‹è´¨é‡ï¼Œè¿™æ—¶å€™éœ€è¦ç»™ Rails æ·»åŠ ä¸€ä¸ªé¢„å‘å¸ƒç¯å¢ƒï¼Œé€šå¸¸å¤§å®¶éƒ½å‘½åä¸º staging ç¯å¢ƒï¼Œå·¥ä½œæµç¨‹ä¹Ÿå¼€å§‹ä¸¥è°¨ï¼š

1. å·¥ç¨‹å¸ˆåœ¨æœ¬åœ°å¼€å‘æ–°åŠŸèƒ½ã€‚ï¼ˆdeveloper ç¯å¢ƒï¼‰
2. åœ¨CIï¼ˆæˆ–æœ¬åœ°ï¼‰è·‘æµ‹è¯•ã€‚ï¼ˆtest ç¯å¢ƒï¼‰
3. ä»£ç åˆå¹¶åˆ° staging åˆ†æ”¯ï¼Œå¹¶ä¸”éƒ¨ç½²åˆ° staging ç¯å¢ƒï¼ŒQA å·¥ç¨‹å¸ˆæµ‹è¯•æ–°åŠŸèƒ½ã€‚
4. å¦‚æœæ²¡æœ‰bugï¼Œåˆ™éƒ¨ç½²åˆ° production ç¯å¢ƒï¼Œä¾›å®¢æˆ·ä½¿ç”¨ã€‚

```
environments
â”œâ”€â”€ development.rb
â”œâ”€â”€ staging.rb
â”œâ”€â”€ production.rb
â””â”€â”€ test.rb
```

## ä¸šåŠ¡çš„ç¬¬äºŒé˜¶æ®µï¼šå¤§é‡å®¢æˆ· + å¤šå›¢é˜Ÿåä½œ

å¦‚æœäº§å“å¸‚åœºåå“è‰¯å¥½ï¼Œå®¢æˆ·è¶Šæ¥è¶Šå¤šã€‚å·¥ç¨‹å¸ˆå›¢é˜Ÿè§„æ¨¡ä¹Ÿç”±å‡ ä¸ªäººæ‰©å¢åˆ°å‡ åäººæˆ–ä¸Šç™¾äººã€‚äººå‘˜ä¼—å¤šï¼Œä¸”å…±ç”¨ä¸€ä¸ª staging ç¯å¢ƒï¼Œåˆå¹¶ä»£ç åˆ° staging åˆ†æ”¯æ—¶å®¹æ˜“å†²çªã€‚

ç¨‹åºå‘˜è€å¿ƒæ—¶ï¼Œé‡åˆ°ä»£ç å†²çªä¼šè”ç³»åŸä½œè€…ï¼Œä¸€èµ·è§£å†³ã€‚å¦‚æœæ˜¯è·¨å›½å›¢é˜Ÿï¼Œå› ä¸ºæ—¶å·®çš„åŸå› ï¼Œä¸€ä¸ªæ¥å›çš„æ²Ÿé€šéœ€è¦ä¸€å¤©æ—¶é—´ã€‚è¿™æ—¶å€™ç¨‹åºå‘˜å¯èƒ½å°±æ²¡äº†è€å¿ƒï¼Œç›´æ¥é‡ç½® git çš„ staging åˆ†æ”¯ã€‚è¿™ä¼šå¯¼è‡´ä¸€ç³»åˆ—çš„è¯¯ä¼šï¼Œåˆ«äººæ­£åœ¨æµ‹è¯•çš„åŠŸèƒ½å‡­ç©ºæ¶ˆå¤±ï¼ŒQA å·¥ç¨‹å¸ˆä¸ŠæŠ¥ bugï¼Œç»“æœç»†æŸ¥ä¸‹æ¥æ˜¯ä»£ç é‡ç½®å¯¼è‡´çš„ã€‚

ä¸ºäº†é™ä½ä»£ç å†²çªå’Œæ²Ÿé€šæˆæœ¬ï¼Œå¾ˆå¤šå…¬å¸ä¼šé€‰æ‹©ä¸ºä¸åŒå›¢é˜Ÿåˆ›å»ºä¸“å±çš„éƒ¨ç½²å®ä¾‹ï¼Œè€Œä¸æ˜¯åƒå¤§é”…é¥­ã€‚å„å›¢é˜Ÿäº•æ°´ä¸çŠ¯æ²³æ°´ï¼Œå¦‚æœæŸä¸ªéƒ¨ç½²å‡ºç° bugï¼Œä¹Ÿåªä¼šå½±å“åˆ°å•ä¸ªå›¢é˜Ÿï¼Œä¸ä¼šæ‹–ç´¯æ•´ä¸ªå…¬å¸å¼€å‘è¿›åº¦ã€‚

| å®ä¾‹ | éƒ¨ç½²çš„Gitåˆ†æ”¯ | ç”¨é€” |
|:--|:--|:--|
| production | release/xxx  | ç»™å®¢æˆ·ä½¿ç”¨çš„ç”Ÿäº§ç¯å¢ƒ |
| demo | demo  | é”€å”®ç»™å®¢æˆ·åšæ¼”ç¤ºã€‚ |
| staging | main / ä¸‹ä¸€ä¸ª release åˆ†æ”¯  | ç”¨äºä¸Šçº¿å‰çš„å›å½’æµ‹è¯• |
| staging-1 | staging-1-branch | ç»™ "å°ç†ŠçŒ«" å›¢é˜Ÿä½¿ç”¨ |
| staging-2 | staging-2-branch | ç»™ "è‡ªæ€å°åˆ†é˜Ÿ" å›¢é˜Ÿä½¿ç”¨ |
| staging-3 | staging-3-branch | ç»™ "æ˜Ÿæ²³æˆ˜èˆ°" å›¢é˜Ÿä½¿ç”¨ |
| staging-4 | staging-4-branch | ç»™ "æ·±æµ·æ°´å¦–" å›¢é˜Ÿä½¿ç”¨ |
| staging-5 | staging-5-branch | ç»™ "é˜¿å°”è´¡" å›¢é˜Ÿä½¿ç”¨ |
| staging-... | staging-6-branch | ç»™ ... å›¢é˜Ÿä½¿ç”¨ |


å·¥ç¨‹å¸ˆè¶Šå¤šï¼Œéœ€è¦çš„ Rails ç¯å¢ƒä¹Ÿè¶Šå¤šã€‚å¦‚ä½•åˆ›å»ºæ›´å¤šçš„éƒ¨ç½²ç¯å¢ƒå‘¢ï¼Ÿ

å¯ä»¥åœ¨ Rails çš„ `config/environments` ç›®å½•ä¸‹åˆ›å»º7ä¸ªç¯å¢ƒçš„é…ç½®æ–‡ä»¶ã€‚è¿™æ˜¯ Rails æ¨èçš„é…ç½®é£æ ¼ï¼ŒåŸæ±åŸå‘³ã€‚

```
> tree environments                                                      
environments
â”œâ”€â”€ demo.rb
â”œâ”€â”€ development.rb
â”œâ”€â”€ production.rb
â”œâ”€â”€ staging.rb
â”œâ”€â”€ staging-1.rb
â”œâ”€â”€ staging-2.rb
â”œâ”€â”€ staging-3.rb
â”œâ”€â”€ staging-4.rb
â”œâ”€â”€ staging-5.rb
â”œâ”€â”€ staging-6.rb
â””â”€â”€ test.rb
```

ä½†äº‹æƒ…æ²¡é‚£ä¹ˆç®€å•ï¼Œé™¤äº† `config/environments`ï¼Œè¿˜æœ‰è®¸å¤šé¢å¤–å·¥ä½œã€‚æˆ‘ä»¬è¦åœ¨ `config/database.yml` æ·»åŠ 7ä¸ªæ–°ç¯å¢ƒçš„æ•°æ®åº“é…ç½®ã€‚

```yaml
default: &default
  adapter: postgresql
  database: <%= ENV['DATABASE_NAME'] %>
  username: <%= ENV.fetch("DATABASE_USER", 'postgres') %>
  password: <%= ENV['DATABASE_PASSWORD'] %>
  port: 5432

production:
  <<: *default
  
demo:
  <<: *default
  
staging-1:
  <<: *default

staging-2:
  <<: *default
  
staging-3:
  <<: *default
...
```

æ­¤å¤–ï¼Œæœ‰äº›å·¥ç¨‹å¸ˆå¦‚æœåœ¨å¸¸é‡å®šä¹‰é…ç½®ï¼Œé‚£æˆ‘ä»¬è¿˜éœ€è¦æ£€æŸ¥å„ç§å¸¸é‡ï¼Œç¡®ä¿æ–°åˆ›å»ºçš„ç¯å¢ƒï¼Œéƒ½æœ‰åŒ¹é…çš„èµ‹å€¼ã€‚å°¤å…¶æ˜¯åœ¨çŠ„è§’æ—®æ—¯é‡Œå®šä¹‰çš„å˜é‡ï¼Œå¦‚æœæ²¡æœ‰å¯Ÿè§‰ï¼Œæ–°ç¯å¢ƒä¼šä¸€ç›´æŠ¥é”™ã€‚æ‰€ä»¥éœ€è¦å…¨å±€æœç´¢ `Rails.env`ï¼Œå…å¾—é—æ¼ã€‚

```
# config/initializers/sidekiq.rb

case Rails.env
when :staging-1
  REDIS_HOST = 'redis-s1.3922002.redis.aws.com:6379'
when :staging-2
  REDIS_HOST = 'redis-s2.3922002.redis.aws.com:6379'
...
```

åœ¨å¸¸é‡é‡Œå®šä¹‰é…ç½®ï¼Œå¤ªå®¹æ˜“å‡ºé”™ã€‚å¤šæ•°å·¥ç¨‹å¸ˆä¼šæŠŠä¸åŒéƒ¨ç½²ç¯å¢ƒçš„é…ç½®æŠ½å‡ºæ¥ï¼Œæ”¾åˆ°ä¸åŒçš„æ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”ç”¨ä¸€äº›åº“æ¥ç®¡ç†é…ç½®ï¼ŒRails å¸¸ç”¨çš„åº“æ˜¯ [rubyconfig/config](https://github.com/rubyconfig/config)ã€‚å¦‚æœå›¢é˜Ÿåœ¨ä½¿ç”¨è¿™äº›åº“ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ä¸ºæ–°ç¯å¢ƒæ·»åŠ é…ç½®æ–‡ä»¶ã€‚

```
config/settings/production.yml
config/settings/staging.yml
config/settings/demo.yml
config/settings/staging-1.yml
config/settings/staging-2.yml
config/settings/staging-3.yml
config/settings/staging-4.yml
config/settings/staging-5.yml
...
```


ä»¥ä¸Šæ–¹æ¡ˆæœ‰å‡ ä¸ªçš„ç¼ºç‚¹ï¼š

ç¬¬ä¸€ï¼Œå³ä½¿æœ‰å®Œå¤‡çš„å†…éƒ¨æ–‡æ¡£ï¼Œå…¨å¥—èµ°ä¸‹æ¥ï¼Œå·¥ç¨‹é‡ä¸å°ï¼ŒäººåŠ›æˆæœ¬å¾ˆé«˜ã€‚

ç¬¬äºŒï¼Œæ¯æ¬¡åˆ›å»ºæ–°ç¯å¢ƒéƒ½è¦ä¿®æ”¹è€ä»£ç ä¸­çš„å¸¸é‡ã€‚ä¿®æ”¹æ­£åœ¨è¿è¡Œçš„è€ä»£ç ä¹ƒå…µå®¶å¤§å¿Œï¼Œç¨æœ‰ä¸æ…å°±ä¼šbugç¼ èº«ï¼Œæ­»æ— è‘¬èº«ä¹‹åœ°ã€‚

ç¬¬ä¸‰ï¼Œå®‰å…¨æ€§å·®ã€‚é…ç½®ä¸­åŒ…å« client_secretï¼Œtokenï¼Œç§é’¥ï¼Œå¦‚æœä»£ç ä¸å¹¸æ³„éœ²ï¼Œå„ç§ç§˜é’¥è¢«ä¸€é”…ç«¯ã€‚ä½¿ç”¨è¿™ç§æ–¹æ¡ˆåˆ›å»ºçš„ docker é•œåƒæ··æ‚äº†å„ç§é…ç½®ä¿¡æ¯ï¼Œä¸å¹²å‡€ã€‚ä¸‡ä¸€æ³„éœ²ï¼Œä¹Ÿæ˜¯ä¸ªéº»çƒ¦äº‹ã€‚

è™½ç„¶æœ‰ç§ç§ç¼ºé™·ï¼Œä½†è¿™ç§ Rails åŸç”Ÿçš„è§£å†³æ–¹æ¡ˆä¹Ÿèƒ½ç»´æŒä¸€æ®µæ—¶é—´ã€‚

## ä¸šåŠ¡çš„ç¬¬ä¸‰é˜¶æ®µï¼šç§æœ‰åŒ–éƒ¨ç½² + ç™¾äººä»¥ä¸Šå¼€å‘å›¢é˜Ÿ

å¾ˆå¤šç¨‹åºå‘˜éƒ½æœ‰ä¸€ä¸ªå‡è®¾ï¼š"production éƒ¨ç½²ç¯å¢ƒåªæœ‰ä¸€ä¸ª"ã€‚æœ‰ä¸¤ä¸ªåŸå› å¯¼è‡´äº†è¿™ç§å‡è®¾ï¼š

1. å¤§éƒ¨åˆ† To C çš„äº§å“ï¼Œåªéœ€è¦ä¸€ä¸ª production éƒ¨ç½²å°±èƒ½æ»¡è¶³æ‰€æœ‰å®¢æˆ·çš„éœ€è¦ã€‚
2. å³ä½¿æ˜¯ To B çš„ SaaSï¼Œä¹Ÿæ˜¯å¤šç§Ÿæˆ· ï¼ˆmulti-tenantï¼‰è®¾è®¡ï¼Œä¸€ä¸ª Production éƒ¨ç½²ç¯å¢ƒå¯ä»¥æ»¡è¶³æ‰€æœ‰ç§Ÿæˆ·çš„éœ€è¦ã€‚

éšç€ä¸šåŠ¡çš„å¢é•¿ï¼Œè¿™ç§å‡è®¾ä¼šè¢«æ‰“ç ´ã€‚

**ä¸€äº›å›½å®¶ä¸ºäº†å›½å®¶å®‰å…¨ï¼Œè¦æ±‚æœ¬å›½çš„å…¬æ°‘çš„æ•°æ®å¿…é¡»ä¿å­˜åœ¨æœ¬å›½çš„æ•°æ®ä¸­å¿ƒ**ã€‚Apple iCloud æ—¢åœ¨ç¾å›½æœ‰æ•°æ®ä¸­å¿ƒï¼Œä¹Ÿåœ¨ä¸­å›½è´µå·æœ‰æ•°æ®ä¸­å¿ƒï¼ŒåŒä¸€å¥—ä»£ç éƒ¨ç½²åœ¨ä¸­å›½å’Œç¾å›½ï¼Œéƒ½æ˜¯ production éƒ¨ç½²å®ä¾‹ã€‚æŠ–éŸ³åœ¨ç¾å›½éƒ¨ç½²åœ¨ Oracle Cloudä¸Šï¼Œåœ¨ä¸­å›½åˆ™éƒ¨ç½²åœ¨è‡ªå·±çš„æœºæˆ¿é‡Œï¼Œä»–ä»¬çš„è¿è¡Œæ¨¡å¼ä¹Ÿéƒ½ä¸º production modeã€‚

**å¤§å®¢æˆ·å¤„äºå®‰å…¨çš„è€ƒè™‘ï¼Œè¦æ±‚ç§æœ‰åŒ–éƒ¨ç½²**ã€‚é˜¿é‡Œäº‘åŒæ ·ä¸€å¥—ä»£ç ï¼Œä¼šå–ç»™æ”¿åºœï¼Œä¸­å›½ç”µä¿¡ï¼Œå…¬å®‰ç³»ç»Ÿï¼Œä»£ç éƒ¨ç½²åœ¨ä»–ä»¬å„è‡ªçš„æœºæˆ¿ã€‚Github ä¼ä¸šç‰ˆå…è®¸ä¼ä¸šéƒ¨ç½²ä»£ç åˆ°è‡ªå·±çš„æœºæˆ¿ï¼Œä»–ä»¬çš„è¿è¡Œæ¨¡å¼ä¹Ÿéƒ½ä¸º productionã€‚


æ‰€ä»¥ä¸€å¥—SaaSï¼Œåœ¨çœŸå®çš„ä¸–ç•Œä¸­çš„éƒ¨ç½²åœºæ™¯åº”è¯¥æ˜¯è¿™ä¸ªæ ·å­ï¼š

| å®ä¾‹ | éƒ¨ç½²çš„Gitåˆ†æ”¯ | ç”¨é€” |
|:--|:--|:--|
| production | release/100\*  | éƒ¨ç½²åœ¨å…¬æœ‰äº‘ä¸Šï¼Œå¤šç§Ÿæˆ·ä½¿ç”¨çš„SaaS |
| production-gov | release/101  | å®¢æˆ·ä¸ºæ”¿åºœï¼Œéƒ¨ç½²åœ¨æ”¿åºœç§æœ‰æœºæˆ¿ |
| production-cnpc | release/99  | å®¢æˆ·ä¸ºä¸­çŸ³æ²¹ï¼Œéƒ¨ç½²åœ¨ä¸­çŸ³æ²¹ç§æœ‰æœºæˆ¿ |
| production-china-police | release/100  | å®¢æˆ·ä¸ºä¸­å›½è­¦å¯Ÿï¼Œéƒ¨ç½²åœ¨å…¬å®‰ç§æœ‰æœºæˆ¿ |
| production-us-police | release/100  | å®¢æˆ·ä¸ºç¾å›½è­¦å¯Ÿï¼Œéƒ¨ç½²åœ¨ AWS |
| production-microsoft | release/100  | å®¢æˆ·ä¸ºå¾®è½¯ï¼Œç§æœ‰åŒ–éƒ¨ç½² |
| demo | demo  | é”€å”®ç»™å®¢æˆ·åšæ¼”ç¤ºã€‚ |
| staging | main / ä¸‹ä¸€ä¸ª release åˆ†æ”¯  | ç”¨äºä¸Šçº¿å‰çš„å›å½’æµ‹è¯• |
| staging-1 | staging-1-branch | ç»™ "å°ç†ŠçŒ«" å›¢é˜Ÿå¼€å‘æµ‹è¯•ä½¿ç”¨ |
| staging-2 | staging-2-branch | ç»™ "è‡ªæ€å°åˆ†é˜Ÿ" å›¢é˜Ÿå¼€å‘æµ‹è¯•ä½¿ç”¨ |
| staging-3 | staging-3-branch | ç»™ "æ˜Ÿæ²³æˆ˜èˆ°" å›¢é˜Ÿå¼€å‘æµ‹è¯•ä½¿ç”¨ |
| staging-4 | staging-4-branch | ç»™ "æ·±æµ·æ°´å¦–" å›¢é˜Ÿå¼€å‘æµ‹è¯•ä½¿ç”¨ |
| staging-5 | staging-5-branch | ç»™ "é˜¿å°”è´¡" å›¢é˜Ÿå¼€å‘æµ‹è¯•ä½¿ç”¨ |
| staging-... | staging-6-branch | ç»™ ... å›¢é˜Ÿå¼€å‘æµ‹è¯•ä½¿ç”¨ |

> note:
> 
> release/xxx ä»£è¡¨æŸä¸ªå·²ç»è¿‡QAæµ‹è¯•çš„éƒ¨ç½²åˆ†æ”¯ã€‚


å½“æœ‰ä¼—å¤š production éƒ¨ç½²ç¯å¢ƒæ—¶ï¼Œéš¾é“è¦æŠŠæ‰€æœ‰é…ç½®éƒ½æ··å…¥åˆ°ä»£ç é‡Œå—ï¼Ÿæ˜¾ç„¶ä¸å¯èƒ½ï¼å®¢æˆ·ä¹Ÿä¸ç­”åº”ï¼

æ‰€ä»¥å¤§å®¶ä¸çº¦è€ŒåŒçš„è®¤ä¸ºä»£ç åº”è¯¥æ— çŠ¶æ€ï¼Œé…ç½®ä¿¡æ¯åº”å•ç‹¬å­˜å‚¨ï¼Œè¿™æ ·å¢åŠ éƒ¨ç½²æ—¶å°±ä¸éœ€è¦æ”¹åŠ¨ä¸€è¡Œä»£ç äº†ã€‚

## The 12-factor Application

Heroku å†™è¿‡ä¸€ç¯‡ SaaS æ¶æ„æ–‡ç«  ã€Š[12-factor  Application](https://12factor.net/)ã€‹ï¼Œæ¦‚æ‹¬äº†è®¾è®¡ SaaS åº”ç”¨çš„12æ¡åŸåˆ™ï¼Œè¢«å¥‰ä¸ºåœ­è‡¬ã€‚æ—¶è‡³ä»Šæ—¥ï¼Œä¾ç„¶æ— å‡ºå…¶å³ã€‚

### ç¬¬ä¸€æ¡åŸåˆ™ï¼šä¸€ä»½åŸºå‡†ä»£ç ï¼ˆCodebaseï¼‰ï¼Œå¤šä»½éƒ¨ç½²ï¼ˆdeployï¼‰

> å°½ç®¡æ¯ä¸ªåº”ç”¨åªå¯¹åº”ä¸€ä»½åŸºå‡†ä»£ç ï¼Œä½†å¯ä»¥åŒæ—¶å­˜åœ¨å¤šä»½éƒ¨ç½²(deploy)ã€‚æ¯ä»½éƒ¨ç½²ç›¸å½“äºè¿è¡Œäº†ä¸€ä¸ªåº”ç”¨çš„å®ä¾‹ã€‚é€šå¸¸ä¼šæœ‰ä¸€ä¸ªç”Ÿäº§ç¯å¢ƒï¼Œä¸€ä¸ªæˆ–å¤šä¸ªé¢„å‘å¸ƒç¯å¢ƒã€‚

![](/media/files/2022/2022-08-12-codebase-deploys.png)

### ç¬¬äºŒæ¡åŸåˆ™ï¼šæ˜¾å¼å£°æ˜ä¾èµ–å…³ç³»ï¼ˆ dependency ï¼‰

åŒæ ·çš„ä»£ç ï¼Œåœ¨ä¸åŒæœºå™¨ï¼Œä¾èµ–è¦ä¸€è‡´ï¼Œè¡Œä¸ºä¹Ÿè¦ä¸€è‡´ï¼Œæ¯”å¦‚ï¼š

- JavaScript ä½¿ç”¨ npm æˆ– yarn æ¥ç®¡ç†å„ç§åº“çš„ä¾èµ–ã€‚
- Ruby ä½¿ç”¨ Bundler æ¥ç®¡ç†å„ç§åº“çš„ç‰ˆæœ¬ä¾èµ–ã€‚
- Docker ä¸ä½†æ‰“åŒ…ä»£ç çš„åº“çš„ä¾èµ–ï¼Œè¿˜æ‰“åŒ…äº†æ“ä½œç³»ç»Ÿçš„ä¾èµ–ã€‚ä»»ä½•äººè·å¾— docker image åéƒ½å¯ä»¥è¿è¡Œä»£ç ï¼Œä¸ä¼šå‡ºç°è¿™ç§å°´å°¬æƒ…å†µï¼šä¸€ä»½ä»£ç åªèƒ½åœ¨æˆ‘çš„ç”µè„‘ä¸Šè·‘ï¼Œä¸èƒ½åœ¨ä½ çš„ç”µè„‘ä¸Šè·‘ã€‚

### ç¬¬ä¸‰æ¡åŸåˆ™ï¼šåœ¨ç¯å¢ƒä¸­å­˜å‚¨é…ç½®

> [The 12-factor App: é…ç½®](https://12factor.net/zh_cn/config)
>   
> 12-Factor æ¨èå°†åº”ç”¨çš„é…ç½®å­˜å‚¨äºç¯å¢ƒå˜é‡ä¸­ï¼ˆ env vars, env ï¼‰ã€‚ç¯å¢ƒå˜é‡å¯ä»¥éå¸¸æ–¹ä¾¿åœ°åœ¨ä¸åŒçš„éƒ¨ç½²é—´åšä¿®æ”¹ï¼Œå´ä¸åŠ¨ä¸€è¡Œä»£ç ã€‚

**Docker**

æ¯”å¦‚ Docker å…è®¸ä½ æŠŠé…ç½®æ”¾åˆ°ç¯å¢ƒå˜é‡ä¸­ï¼Œä»è€Œåˆ›å»ºä¸åŒçš„å®ä¾‹ï¼ˆcontainerï¼‰ã€‚

```
docker run --name postgresql \
  -e POSTGRES_USER=myusername \
  -e POSTGRES_PASSWORD=mypassword \
  -p 5432:5432 -v /data:/var/lib/postgresql/data \
  -d postgres
```

**Helm**

[Helm](https://helm.sh/) æ˜¯ä¸€ä¸ª Kubernetes åº”ç”¨çš„åŒ…ç®¡ç†å·¥å…·ï¼Œå®ƒæœ‰ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œchartï¼Œconfigï¼Œreleaseã€‚

- chart æ˜¯æ¨¡ç‰ˆ
- config æ˜¯é…ç½®ä¿¡æ¯

chart + config = release ï¼ˆä¸€ä¸ªéƒ¨ç½²çš„å®ä¾‹ï¼‰


## æŒ‰ 12-factor åŸåˆ™ä¼˜åŒ–æ–¹æ¡ˆ 

ç¬¬ä¸€æ­¥ï¼Œè®©ä»£ç æ— çŠ¶æ€ï¼Œä»£ç ä¸­æ‰€æœ‰çš„é…ç½®ä¿¡æ¯éƒ½å–è‡ªç¯å¢ƒå˜é‡ã€‚

æ¯”å¦‚ï¼ŒDB çš„é…ç½®è¦å–è‡ªç¯å¢ƒå˜é‡ã€‚

```yml
# config/database.yml
# ...
production:
  <<: *default
  database: <%= ENV['DATABASE_NAME' %>
  host: <%= ENV['DATABASE_HOST'] %>
  password: <%= ENV['DATABASE_PASSWORD'] %>
```

Sidekiq çš„é…ç½®ä¹Ÿå–è‡ªç¯å¢ƒå˜é‡ã€‚

```ruby
Sidekiq.configure_server do |config|
  config.redis = {
    host: ENV['REDIS_HOST'],
    port: 6379
  }
end
# ...
```

ä»»ä½•é€»è¾‘ï¼Œä½†å‡¡å’Œç¯å¢ƒç›¸å…³ï¼Œå…¶é…ç½®éƒ½å–è‡ªç¯å¢ƒå˜é‡ã€‚

```ruby
class OauthController < ApiController
  def redirect
    redirect_to(ENV['GOOGLE_OAUTH_URL'])
  end
end
```

ç¬¬äºŒæ­¥ï¼Œå‡†å¤‡é…ç½®æ–‡ä»¶ã€‚

ä¸º staging-1, staging-2, staging-3, staging-4, staging-5, ... staging-xï¼Œdemoï¼Œproductionï¼Œproduction-govï¼Œproduction-china-policeï¼Œproduction-us-police ç­‰éƒ¨ç½²ç¯å¢ƒåˆ›å»ºé…ç½®æ–‡ä»¶ã€‚

å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ AWSï¼Œå¯ä»¥æŠŠæŸä¸ªéƒ¨ç½²çš„é…ç½®ä¿å­˜åœ¨ [Parameter Store](https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html)ï¼Œæ•æ„Ÿä¿¡æ¯å¯ä»¥ä¿å­˜åœ¨ [AWS secret manager](https://aws.amazon.com/secrets-manager/)ã€‚

```
# åˆ›å»º staging-1 çš„é…ç½®ä¿¡æ¯
aws ssm put-parameter \
    --name "staging-1-configuration" \
    --value "parameter-value" \
    --type String \
    --tags "DB_HOST=xxx,DB_USER=xxx,DB_PASSWORD=xxx,REDIS_HOST=xxx,GOOGLE_OAUTH_URL=xxxx"
```

å¦‚æœä½ æ˜¯ç”¨çš„æ˜¯ Kubernetesï¼Œå¯ä»¥æŠŠä¸åŒéƒ¨ç½²çš„é…ç½®ä¿¡æ¯ä¿å­˜åœ¨ä¸åŒçš„ [ConfigMap](https://kubernetes.io/docs/concepts/configuration/configmap/)ï¼Œæ•æ„Ÿä¿¡æ¯ä¿å­˜åœ¨ [Secret](https://kubernetes.io/docs/concepts/configuration/secret/) ä¸­ã€‚

```
kubectl create configmap staging1-config-map \
  --from-literral="DB_HOST=xxx" \
  --from-literral="DB_USER=postgres" \
  --from-literral="DB_PASSWORD=xxx"
```


ç¬¬ä¸‰æ­¥ï¼Œä»¥ production mode è¿è¡Œå„ä¸ªéƒ¨ç½²ç¯å¢ƒã€‚

å› ä¸ºæœ‰ä¼—å¤šçš„ production ç¯å¢ƒï¼Œä¹Ÿæœ‰ä¼—å¤šçš„ staging ç¯å¢ƒï¼Œ `config/environments` ä¸‹çš„ä¸ªæ–‡ä»¶ production.rb / staging.rb å’Œè¿è¡Œå®ä¾‹æ²¡æœ‰å…³ç³»ï¼Œè€Œæ˜¯ä»£è¡¨ä¸€ç§è¿è¡Œçš„æ¨¡å¼ã€‚

staging-1, staging-2, staging-3, staging-4, staging-5, ... staging-xï¼Œdemoï¼Œproductionï¼Œproduction-govï¼Œproduction-china-policeï¼Œproduction-us-police å†…éƒ¨çš„è¿è¡Œè„šæœ¬éƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š

```
export .env
RAILS_ENV=production rails s
```

![](/media/files/2022/2022-08-12_14-07-10-production-yml.jpg)

ç¬¬å››æ­¥ï¼š æŠŠä»£ç å’Œé…ç½®ç»„åˆåœ¨ä¸€èµ·ï¼Œåˆ›å»ºä¸€ä¸ªéƒ¨ç½²å®ä¾‹ã€‚


![](/media/files/2022/2022-08-12-codebase-build-config-deploy.png)

å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Capistrano éƒ¨ç½²ä»£ç ï¼Œé‚£ä¹ˆ

```
Code + ä¸åŒé…ç½® = éƒ¨ç½²å®ä¾‹
```

å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Docker éƒ¨ç½²ï¼Œé‚£ä¹ˆï¼š

```
Docker Image + ä¸åŒé…ç½® = éƒ¨ç½²å®ä¾‹
```

å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Kubenetesï¼Œå°†ä¸åŒé…ç½®æ–‡ä»¶æ³¨å…¥åˆ°äº†Pod ä¸­ï¼Œå°±å˜æˆäº†ä¸åŒçš„éƒ¨ç½²å®ä¾‹ã€‚

```yaml
---
apiVersion: v1
kind: Pod
metadata:
  labels:
    name: webapp
  name: webapp
  namespace: default
spec:
  containers:
  - name: web-app
    image: web-app:staging-1
    envFrom:
    - configMapRef:  ğŸ‘ˆ çœ‹è¿™é‡Œ
        name: staging-1-config-map
    - secretRef:     ğŸ‘ˆ çœ‹è¿™é‡Œ
        name: staging-1-secrets
```


### ä¼˜ç‚¹

åˆ›å»ºéƒ¨ç½²å®ä¾‹ï¼Œåªéœ€è¦å‡†å¤‡ä¸€ä»½æ–°çš„é…ç½®æ–‡ä»¶å°±å¯ä»¥ï¼Œçœäº‹çœåŠ›ã€‚

ä»£ç å’Œ Docker image ä¸­ä¸åŒ…å«æœºå¯†ä¿¡æ¯ã€‚å³ä½¿ä»£ç æ³„éœ²ä¹Ÿä¸ä¼šæ‰©å¤§é£é™©ï¼Œå…¶æ¬¡ä¹Ÿæ–¹ä¾¿ç§æœ‰åŒ–éƒ¨ç½²ã€‚

å¯ä»¥ä¸ºä¸åŒéƒ¨ç½²çš„é…ç½®æ–‡ä»¶å¯ä»¥è®¾ç½®ä¸åŒçš„è®¿é—®æƒé™ï¼Œæ¯”å¦‚ä»…ä»…å…è®¸ç‰¹å®šå›¢é˜Ÿè®¿é—® production éƒ¨ç½²å®ä¾‹çš„çš„é…ç½®ä¿¡æ¯ã€‚

åœ¨æœ¬æ–‡ä¸­æ‰€æœ‰éƒ¨ç½²çš„è¿è¡Œæ¨¡å¼éƒ½æ˜¯ production modeï¼Œä»¥æ­¤æ¶ˆé™¤äº†ä¸åŒéƒ¨ç½²çš„å·®å¼‚ ([parity](https://12factor.net/dev-prod-parity))ã€‚


### ç¼ºç‚¹

NewRelic, Datadog, Sentry ç­‰ç›‘æ§å·¥å…·é»˜è®¤ä¼šæŠŠç¯å¢ƒä¿¡æ¯é™„ç€åœ¨ç›‘æ§æ•°æ®ä¸Šï¼Œæ–¹ä¾¿ç­›é€‰è¿‡æ»¤ã€‚

![](/media/files/2022/2022-08-12_12-47-48.jpg)

åœ¨ç¬¬äºŒç§æ–¹æ¡ˆä¸­ï¼Œæ‰€æœ‰çš„éƒ¨ç½²å®ä¾‹çš„è¿è¡Œæ¨¡å¼éƒ½ä¸º production modeï¼Œè¿™å¯¼è‡´æ‰€æœ‰ç›‘æ§æ•°æ®éƒ½æ··åœ¨ production ä¸‹ã€‚é‡åˆ°äº‹æ•…ï¼Œå·¥ç¨‹å¸ˆæ ¹æœ¬æ— æ³•æ’æŸ¥æ˜¯å“ªä¸ªéƒ¨ç½²å®ä¾‹å‡ºäº†é—®é¢˜ã€‚

![](/media/files/2022/2022-08-12_12-56-12-only-production.jpg)

## å¦‚ä½•è§£å†³ç›‘æ§å·¥å…·çš„é—®é¢˜ï¼Ÿ

å…¶å® NewRelic, Datadog, Sentry æä¾›äº†æ¥å£ï¼Œå…è®¸æˆ‘ä»¬è‡ªå®šä¹‰éƒ¨ç½²å®ä¾‹çš„åå­—ï¼Œä»¥ Sentry ä¸¾ä¾‹ï¼Œå®ƒçš„è¯­æ³•å¦‚ä¸‹ï¼š
 
 ```ruby
Sentry.init do |config|
  #...
  config.environment = "ä½ å–œæ¬¢çš„éƒ¨ç½²å"
end
```

å› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨ staging-1, staging-2, staging-x, production-x ç­‰ä¸åŒéƒ¨ç½²å®ä¾‹çš„é…ç½®ä¸­ï¼Œå¼•å…¥ä¸€ä¸ªæ–°çš„å˜é‡ "DEPLOYMENT_ID" æ¥å£°æ˜å®ä¾‹çš„åç§°ï¼Œå¹¶èµ‹å€¼ç»™ç›‘æ§å·¥å…·ã€‚
 
å‡å¦‚ staging-1 çš„é…ç½®ä¿¡æ¯å¦‚ä¸‹ï¼š

```
DEPLOYMENT_ID=staging-1
DB_HOST=staging-1.db
DB_USER=postgres
...
```

æˆ‘ä»¬å¯ä»¥è¿™æ ·é…ç½® Sentryï¼š

```ruby
Sentry.init do |config|
  #...
  config.environment = ENV['DEPLOYMENT_ID'] # å®ƒçš„å€¼ä¸º staging-1
end
```

å¯ä»¥è¿™æ ·é…ç½® Datadogï¼š

```ruby
Datadog.configure do |c|
  # ...
  c.env = ENV['DEPLOYMENT_ID'] # å®ƒçš„å€¼ä¸º staging-1
end
```

è¿™æ ·å°±èƒ½ä¿è¯ç›‘æ§å·¥å…·çš„æ­£å¸¸æ˜¾ç¤ºäº†ã€‚

![](/media/files/2022/2022-08-12_20-35-02-deploy.jpg)


**æ„Ÿè°¢**

æœ¬æ–‡ä¸­çš„æ–¹æ¡ˆï¼Œæ¥è‡ªäº Workstream åŒäº‹ä»¬ å’Œ SAP å‰åŒäº‹ä»¬çš„å®è·µç»éªŒï¼Œæˆ‘åªæ˜¯æç¬”è®°å½•ä¸‹æ¥ã€‚

ç‰¹åˆ«æ„Ÿè°¢ Louise Xu, Felix Chen, Vincent Huang, Teddy Wang, Kang Zhang çš„å®¡æ ¡å’Œåé¦ˆã€‚