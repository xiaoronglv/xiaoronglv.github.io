---
title: "Rails åº”ç”¨çš„ç¯å¢ƒç®¡ç†ç»éªŒ"
layout: post
guid: XKPa1KmnJCcD
date: 2022-08-12
coffee:
tags:
  -
---

å½“ä½¿ç”¨å‘½ä»¤è¡Œ `rails new` å»åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®æ—¶ï¼ŒRails é»˜è®¤ä¼šåˆ›å»ºä¸‰ä¸ªç¯å¢ƒï¼š

- development: æœ¬åœ°å¼€å‘ç¯å¢ƒã€‚
- test: ç”¨æ¥è·‘æµ‹è¯•ã€‚
- production: ç”Ÿäº§ç¯å¢ƒï¼Œç”¨æ¥æœåŠ¡å®¢æˆ·ã€‚

åœ¨é¡¹ç›®çš„æœ€æ—©æœŸï¼Œè¿˜å¤„äºéªŒè¯æƒ³æ³•é˜¶æ®µã€‚å·¥ç¨‹å¸ˆçš„å·¥ä½œæµç¨‹ä¹Ÿæ¯”è¾ƒç²—ç‹‚ï¼Œå†™ä»£ç ï¼Œè·‘æµ‹è¯•ï¼Œç„¶åç›´æ¥éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒã€‚

**å°‘é‡å®¢æˆ·é˜¶æ®µ**

äº§å“ä¸æ–­è¿­ä»£ï¼Œé€æ¸çš„æœ‰å®¢æˆ·å¼€å§‹ä½¿ç”¨äº§å“ã€‚ä¸ºäº†ä¿è¯å·¥ç¨‹è´¨é‡ï¼Œè¿™æ—¶å€™éœ€è¦ç»™ Rails æ·»åŠ ä¸€ä¸ªé¢„å‘å¸ƒç¯å¢ƒï¼Œé€šå¸¸å¤§å®¶éƒ½å‘½åä¸º staging ç¯å¢ƒï¼Œå·¥ä½œæµç¨‹ä¹Ÿå¼€å§‹ä¸¥è°¨ï¼š

1. å·¥ç¨‹å¸ˆåœ¨æœ¬åœ°å¼€å‘æ–°åŠŸèƒ½ã€‚ï¼ˆdeveloper ç¯å¢ƒï¼‰
2. åœ¨CIï¼ˆæˆ–æœ¬åœ°ï¼‰è·‘æµ‹è¯•ã€‚ï¼ˆtest ç¯å¢ƒï¼‰
3. ä»£ç éƒ¨ç½²åˆ° staging ç¯å¢ƒï¼ŒQA å·¥ç¨‹å¸ˆæµ‹è¯•æ–°åŠŸèƒ½ ï¼ˆstagingç¯å¢ƒï¼‰
4. å¦‚æœæ²¡æœ‰bugï¼Œåˆ™éƒ¨ç½²åˆ° production ç¯å¢ƒï¼Œä¾›å®¢æˆ·ä½¿ç”¨ã€‚

```
environments
â”œâ”€â”€ development.rb
â”œâ”€â”€ staging.rb
â”œâ”€â”€ production.rb
â””â”€â”€ test.rb
```

**å¤§é‡å®¢æˆ· + å¤šå›¢é˜Ÿåä½œ + å¤š QA**

å¦‚æœäº§å“å¸‚åœºåå“è‰¯å¥½ï¼Œå®¢æˆ·è¶Šæ¥è¶Šå¤šã€‚å·¥ç¨‹å¸ˆå›¢é˜Ÿè§„æ¨¡ä¹Ÿç”±å‡ ä¸ªäººæ‰©å¢åˆ°å‡ åäººæˆ–ä¸Šç™¾äººã€‚äººå‘˜ä¼—å¤šï¼Œä¸”å…±ç”¨ä¸€ä¸ª staging ç¯å¢ƒï¼Œåˆå¹¶ä»£ç åˆ° staging åˆ†æ”¯æ—¶å°±ä¼šæœ‰è¶Šæ¥è¶Šå¤šçš„å†²çªã€‚

æœ‰äº›ç¨‹åºå‘˜æ¯”è¾ƒè€å¿ƒï¼Œé‡åˆ°å†²çªä¼šè”ç³»åŸä½œè€…ï¼Œä¸€èµ·è§£å†³ä»£ç å†²çªã€‚

ä½†æ˜¯å¦‚æœæ˜¯è·¨å›½å›¢é˜Ÿï¼Œå› ä¸ºæ—¶å·®çš„åŸå› ï¼Œä¸€æ¥ä¸€å›çš„æ²Ÿé€šéœ€è¦ä¸€å¤©æ—¶é—´ï¼Œéå¸¸è¦å‘½ã€‚è¿™æ—¶å€™ç¨‹åºå‘˜å¯èƒ½å°±æ²¡æœ‰è€å¿ƒï¼Œé€‰æ‹©ç›´æ¥é‡ç½® staging åˆ†æ”¯ï¼Œè¿™ä¼šå¯¼è‡´åˆ«äººæ­£åœ¨æµ‹è¯•çš„åŠŸèƒ½å‡­ç©ºæ¶ˆå¤±ï¼ŒQA å·¥ç¨‹å¸ˆä¸ŠæŠ¥ bugï¼Œç»“æœç»†æŸ¥ä¸‹æ¥æ˜¯ä»£ç é‡ç½®å¯¼è‡´çš„ã€‚

ä¸ºäº†é™ä½ä»£ç å†²çªå’Œæ²Ÿé€šæˆæœ¬ï¼Œå¾ˆå¤šå…¬å¸ä¼šé€‰æ‹©åˆ›å»ºæ›´å¤šçš„é¢„å‘å¸ƒ(staging)ç¯å¢ƒï¼š

- staging ç»™ QA ä¸“ç”¨ï¼Œç”¨äºä¸Šçº¿å‰çš„å›å½’æµ‹è¯•ã€‚
- staging-1 ç»™ A å›¢é˜Ÿä½¿ç”¨
- staging-2 ç»™ B å›¢é˜Ÿä½¿ç”¨
- staging-3 ç»™ C å›¢é˜Ÿä½¿ç”¨
- staging-4 ç»™ D å›¢é˜Ÿä½¿ç”¨
- staging-5 ç»™ E å›¢é˜Ÿä½¿ç”¨
- ...
- staging-x ç»™ x å›¢é˜Ÿä½¿ç”¨

å·¥ç¨‹å¸ˆè¶Šå¤šï¼Œéœ€è¦çš„ Rails ç¯å¢ƒä¹Ÿè¶Šå¤šï¼Œç¯å¢ƒçš„åˆ›å»ºå’Œç»´æŠ¤å˜æˆ DevOps çš„ä½“åŠ›æ´»ã€‚

å¦‚ä½•åˆ›å»ºæ–°ç¯å¢ƒå‘¢ï¼Ÿ

## ç¬¬ä¸€ç§æ–¹æ¡ˆï¼š åœ¨ Rails çš„ `config/environments` ç›®å½•ä¸‹åˆ›å»º6ä¸ªç¯å¢ƒçš„é…ç½®æ–‡ä»¶ã€‚

è¿™æ˜¯ Rails æ¨èçš„é…ç½®é£æ ¼ï¼Œæ–¹æ³•ç®€å•ï¼ŒåŸæ±åŸå‘³ã€‚

![](/media/files/2022/2022-08-12-08-41-03-stagings.jpg)

ä½†é™¤äº† `config/environments`ï¼Œè¿˜æœ‰è®¸å¤šé¢å¤–å·¥ä½œã€‚æˆ‘ä»¬éœ€è¦åœ¨ `config/database.yml` æ·»åŠ 6ä¸ªç¯å¢ƒçš„æ•°æ®åº“é…ç½®ã€‚

![](/media/files/2022/2022-08-12-database-yml.jpg)

æœ‰äº›å·¥ç¨‹å¸ˆå–œæ¬¢æŠŠä¸€äº›é…ç½®æ”¾åˆ°å¸¸é‡é‡Œã€‚é‚£æˆ‘ä»¬è¿˜éœ€è¦æ£€æŸ¥å„ç§å¸¸é‡ï¼Œç¡®ä¿æ–°åˆ›å»ºçš„ç¯å¢ƒï¼Œéƒ½æœ‰èµ‹å€¼ã€‚å°¤å…¶æ˜¯åœ¨çŠ„è§’æ—®æ—¯é‡Œå®šä¹‰çš„å˜é‡ï¼Œå¦‚æœæ²¡æœ‰å¯Ÿè§‰ï¼Œæ–°ç¯å¢ƒä¼šä¸€ç›´æŠ¥é”™ã€‚æ‰€ä»¥éœ€è¦å…¨å±€æœç´¢ `Rails.env`ï¼Œå…å¾—é—æ¼ã€‚

```
# config/initializers/sidekiq.rb

case Rails.env
when :staging-1
  REDIS_HOST = 'redis-s1.3922002.redis.aws.com:6379'
when :staging-2
  REDIS_HOST = 'redis-s2.3922002.redis.aws.com:6379'
...
...
```

åœ¨å¸¸é‡é‡Œå®šä¹‰é…ç½®ï¼Œç³Ÿç³•é€é¡¶ã€‚æ‰€ä»¥æœ‰å“ä½çš„å·¥ç¨‹å¸ˆä¼šæŠŠä¸åŒç¯å¢ƒçš„é…ç½®æŠ½è±¡å‡ºæ¥ï¼Œæ”¾åˆ°ä¸åŒçš„æ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”ç”¨ä¸€äº›åº“æ¥ç®¡ç†é…ç½®ï¼ŒRails å¸¸ç”¨çš„åº“æ˜¯ [rubyconfig/config](https://github.com/rubyconfig/config)ã€‚æˆ‘ä»¬ä¹Ÿéœ€è¦ä¸ºæ–°åˆ›å»ºçš„ç¯å¢ƒæ·»åŠ é…ç½®æ–‡ä»¶ã€‚

```
config/settings.yml
config/settings.local.yml
config/settings/development.yml
config/settings/production.yml
config/settings/test.yml
config/settings/staging.yml
config/settings/staging-1.yml
config/settings/staging-2.yml
config/settings/staging-3.yml
config/settings/staging-4.yml
config/settings/staging-5.yml
```


æ€»ä¹‹ï¼Œä»¥ä¸Šéƒ½ä¸æ˜¯ä¸‡å…¨ä¹‹ç­–ï¼Œæœ‰è¯¸å¤šç¼ºç‚¹ï¼š

1. å³ä½¿æœ‰å®Œå¤‡çš„å†…éƒ¨æ–‡æ¡£ï¼Œæ­å»ºæ–°ç¯å¢ƒä¹Ÿéå¸¸è€—æ—¶è€—åŠ›ï¼Œå…¨å¥—èµ°ä¸‹æ¥ï¼Œå·¥ç¨‹é‡ä¸å°ã€‚
2. ä¿®æ”¹å¸¸é‡å¾ˆå±é™©ï¼Œåˆ›å»ºç¯å¢ƒä¼šè§¦ç¢°è€ä»£ç ï¼Œç¨æœ‰ä¸æ…å°±ä¼šæ¯æ‰æ‰€æœ‰ç¯å¢ƒï¼Œè¿èƒŒäº†å¼€æ”¾å°é—­åŸåˆ™ï¼ˆOpenâ€“closed principleï¼‰ã€‚
3. å®‰å…¨æ€§å·®ã€‚é…ç½®ä¸­åŒ…å« client_secretï¼Œtokenï¼Œç§é’¥ï¼Œå¦‚æœä»£ç ä¸å¹¸æ³„éœ²ï¼Œå„ç§ç§˜é’¥è¢«ä¸€é”…ç«¯ã€‚é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼ŒRails 6 æ¨å‡ºäº† [Rails Credential](https://edgeguides.rubyonrails.org/security.html#environmental-security) è¿™ä¸ªåŠŸèƒ½ã€‚
3. docker é•œåƒæ··æ‚äº†å„ç§é…ç½®ä¿¡æ¯ï¼Œä¸å†å¹²å‡€ã€‚

æ­£å› ä¸ºå¦‚æ­¤å¤šçš„ç¼ºç‚¹ï¼Œå¤§å®¶ä¸çº¦è€ŒåŒçš„æŠŠé…ç½®ä¿¡æ¯æ”¾åˆ°ç¯å¢ƒå˜é‡ä¸­ï¼Œå¹¶ä¸”å½’çº³æ€»ç»“äº†ä¸€äº›æœ€ä½³å®è·µä¾›åäººå­¦ä¹ ã€‚

## The 12-factor Application

Heroku å†™è¿‡ä¸€ç¯‡å¥‰ä¸ºåœ­è‡¬çš„ SaaS æ¶æ„æ–‡ç«  ã€Š[12-factor  Application](https://12factor.net/)ã€‹ï¼Œé‡Œé¢æè¿°äº†è®¾è®¡ SaaS åº”ç”¨çš„12æ¡åŸåˆ™ã€‚æ—¶è‡³ä»Šæ—¥ï¼Œä¾ç„¶æ— å‡ºå…¶å³ã€‚

### ç¬¬ä¸€æ¡åŸåˆ™ï¼šä¸€ä»½åŸºå‡†ä»£ç ï¼ˆCodebaseï¼‰ï¼Œå¤šä»½éƒ¨ç½²ï¼ˆdeployï¼‰

> å°½ç®¡æ¯ä¸ªåº”ç”¨åªå¯¹åº”ä¸€ä»½åŸºå‡†ä»£ç ï¼Œä½†å¯ä»¥åŒæ—¶å­˜åœ¨å¤šä»½éƒ¨ç½²(deploy)ã€‚æ¯ä»½éƒ¨ç½²ç›¸å½“äºè¿è¡Œäº†ä¸€ä¸ªåº”ç”¨çš„å®ä¾‹ã€‚é€šå¸¸ä¼šæœ‰ä¸€ä¸ªç”Ÿäº§ç¯å¢ƒï¼Œä¸€ä¸ªæˆ–å¤šä¸ªé¢„å‘å¸ƒç¯å¢ƒã€‚

![](/media/files/2022/2022-08-12-codebase-deploys.png)

### ç¬¬äºŒæ¡åŸåˆ™ï¼šæ˜¾å¼å£°æ˜ä¾èµ–å…³ç³»ï¼ˆ dependency ï¼‰

åŒæ ·çš„ä»£ç ï¼Œåœ¨ä¸åŒæœºå™¨ï¼Œä¾èµ–è¦ä¸€è‡´ï¼Œè¡Œä¸ºä¹Ÿè¦ä¸€è‡´ï¼Œæ¯”å¦‚ï¼š

- JavaScript ä½¿ç”¨ npm æˆ– yarn æ¥ç®¡ç†å„ç§åº“çš„ä¾èµ–ã€‚
- Ruby ä½¿ç”¨ Bundler æ¥ç®¡ç†å„ç§åº“çš„ç‰ˆæœ¬ä¾èµ–ã€‚
- Docker ä¸ä½†æ‰“åŒ…ä»£ç çš„åº“çš„ä¾èµ–ï¼Œè¿˜æ‰“åŒ…äº†æ“ä½œç³»ç»Ÿçš„ä¾èµ–ã€‚ä»»ä½•äººè·å¾— docker image åéƒ½å¯ä»¥è¿è¡Œä»£ç ï¼Œä¸ä¼šå‡ºç°è¿™ç§å°´å°¬æƒ…å†µï¼šä¸€ä»½ä»£ç åªèƒ½åœ¨æˆ‘çš„ç”µè„‘ä¸Šè·‘ï¼Œä¸èƒ½åœ¨ä½ çš„ç”µè„‘ä¸Šè·‘ã€‚

### ç¬¬ä¸‰æ¡åŸåˆ™ï¼šåœ¨ç¯å¢ƒä¸­å­˜å‚¨é…ç½®

> [The 12-factor App: é…ç½®](https://12factor.net/zh_cn/config)
> 
> 12-Factor æ¨èå°†åº”ç”¨çš„é…ç½®å­˜å‚¨äºç¯å¢ƒå˜é‡ä¸­ï¼ˆ env vars, env ï¼‰ã€‚ç¯å¢ƒå˜é‡å¯ä»¥éå¸¸æ–¹ä¾¿åœ°åœ¨ä¸åŒçš„éƒ¨ç½²é—´åšä¿®æ”¹ï¼Œå´ä¸åŠ¨ä¸€è¡Œä»£ç ã€‚

**Docker**

æ¯”å¦‚ Docker å…è®¸ä½ æŠŠé…ç½®æ”¾åˆ°ç¯å¢ƒå˜é‡ä¸­ï¼Œä»è€Œåˆ›å»ºä¸åŒçš„å®ä¾‹ï¼ˆcontainerï¼‰ã€‚

```
docker run --name postgresql \
  -e POSTGRES_USER=myusername \
  -e POSTGRES_PASSWORD=mypassword \
  -p 5432:5432 -v /data:/var/lib/postgresql/data \
  -d postgres
```

**Helm**

[Helm](https://helm.sh/) æ˜¯ä¸€ä¸ª Kubernetes åº”ç”¨çš„åŒ…ç®¡ç†å·¥å…·ï¼Œå®ƒæœ‰ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œchartï¼Œconfigï¼Œreleaseã€‚

- chart æ˜¯æ¨¡ç‰ˆ
- config æ˜¯é…ç½®ä¿¡æ¯

chart + config = release ï¼ˆä¸€ä¸ªéƒ¨ç½²çš„å®ä¾‹ï¼‰

**å‰æ–‡æ‰€è¿°çš„ç¬¬ä¸€ç§æ–¹æ¡ˆï¼Œæ¯æ¬¡æ·»åŠ æ–°ç¯å¢ƒéƒ½è¦æ”¹åŠ¨ä»£ç ï¼Œå®Œå…¨ä¸ç¬¦åˆ 12-factor Application çš„åŸåˆ™ã€‚**

å¦‚ä½•æ”¹è¿›ï¼Ÿ

## ç¬¬äºŒç§æ–¹æ¡ˆï¼šä»£ç æ— çŠ¶æ€ï¼Œé…ç½®ä¿¡æ¯ä¸ä»£ç åˆ†ç¦»ã€‚

ç¬¬ä¸€æ­¥ï¼Œä¿è¯ä»£ç ä¸­æ‰€æœ‰çš„é…ç½®ä¿¡æ¯éƒ½å–è‡ªç¯å¢ƒå˜é‡ï¼Œä»£ç æ— çŠ¶æ€ã€‚

æ¯”å¦‚ï¼ŒDB çš„é…ç½®ï¼Œè¦å–è‡ªç¯å¢ƒå˜é‡ã€‚

```yml
# config/database.yml
# ...
production:
  <<: *default
  database: <%= ENV['DATABASE_NAME' %>
  host: <%= ENV['DATABASE_HOST'] %>
  password: <%= ENV['DATABASE_PASSWORD'] %>
```

Sidekiq çš„é…ç½®ä¹Ÿå–è‡ªç¯å¢ƒå˜é‡ã€‚

```ruby
Sidekiq.configure_server do |config|
  config.redis = {
    host: ENV['REDIS_HOST'],
    port: 6379
  }
end
# ...
```

ä»»ä½•é€»è¾‘ï¼Œä½†å‡¡å’Œç¯å¢ƒç›¸å…³ï¼Œå…¶é…ç½®éƒ½å–è‡ªç¯å¢ƒå˜é‡ã€‚

```ruby
class OauthController < ApiController
  def redirect
    redirect_to(ENV['GOOGLE_OAUTH_URL'])
  end
end
```

ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬ä¸å†ç§°å‘¼ staging-1, staging-2, staging-3, staging-4, staging-5, ... staging-xï¼Œproduction ä¸ºç¯å¢ƒï¼Œè€Œæ˜¯æŠŠä»–ä»¬çœ‹åšä»£ç çš„è¿è¡Œå®ä¾‹ï¼Œç§°ä¹‹ä¸ºéƒ¨ç½² (deploy)ï¼Œæ¯ä¸ªéƒ¨ç½²éƒ½æœ‰è‡ªå·±çš„é…ç½®æ–‡ä»¶ã€‚

å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ AWSï¼Œå¯ä»¥æŠŠæŸä¸ªéƒ¨ç½²(deploy) çš„é…ç½®ä¿å­˜åœ¨ [Parameter Store](https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html)ï¼Œæ•æ„Ÿä¿¡æ¯å¯ä»¥ä¿å­˜åœ¨ [AWS secret manager](https://aws.amazon.com/secrets-manager/)ã€‚

```
# åˆ›å»º staging-1 çš„é…ç½®ä¿¡æ¯
aws ssm put-parameter \
    --name "staging-1-configuration" \
    --value "parameter-value" \
    --type String \
    --tags "DB_HOST=xxx,DB_USER=xxx,DB_PASSWORD=xxx,REDIS_HOST=xxx,GOOGLE_OAUTH_URL=xxxx"
```

å¦‚æœä½ æ˜¯ç”¨çš„æ˜¯ Kubernetesï¼Œå¯ä»¥æŠŠä¸åŒéƒ¨ç½²çš„é…ç½®ä¿¡æ¯ä¿å­˜åœ¨ä¸åŒçš„ [ConfigMap](https://kubernetes.io/docs/concepts/configuration/configmap/)ï¼Œæ•æ„Ÿä¿¡æ¯ä¿å­˜åœ¨ [Secret](https://kubernetes.io/docs/concepts/configuration/secret/) ä¸­ã€‚

```
kubectl create configmap staging1-config-map \
  --from-literral="DB_HOST=xxx" \
  --from-literral="DB_USER=postgres" \
  --from-literral="DB_PASSWORD=xxx"
```


ç¬¬ä¸‰æ­¥ï¼Œæˆ‘ä»¬æŠŠ `config/environments` ä¸‹çš„ä¸‰ä¸ªæ–‡ä»¶ production.rb / staging.rb /development.rb / test.rb çœ‹åš Rails ä¸åŒçš„è¿è¡Œæ¨¡å¼ï¼ˆmodeï¼‰ï¼Œè€Œä¸æ˜¯çœ‹åšè¿è¡Œå®ä¾‹ã€‚

æ¢è¨€ä¹‹æ— è®ºæ˜¯ production, staging-1ï¼Œ staging-2ï¼Œ staging-3ï¼Œ staging-4ï¼Œstaging-5ï¼Œè¿˜æ˜¯å°†æ¥çš„ staging-100ï¼Œå®ƒä»¬æ—¢å¯ä»¥é€‰æ‹© `production` çš„è¿è¡Œæ¨¡å¼ï¼Œä¹Ÿå¯ä»¥é€‰æ‹© `staging` çš„è¿è¡Œæ¨¡å¼ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µæ¥å†³å®šã€‚

åœ¨æœ¬æ–‡ä¸­ï¼Œæ‰€æœ‰çš„éƒ¨ç½²ï¼ˆdeployï¼‰éƒ½ä½¿ç”¨ production mode å»è¿è¡Œã€‚

```
export .env.staging-1
RAILS_ENV=production rails s
```

![](/media/files/2022/2022-08-12_14-07-10-production-yml.jpg)

ç¬¬å››æ­¥ï¼š ä»£ç  + ä¸åŒçš„é…ç½® = ä¸åŒçš„éƒ¨ç½²(deploy)ã€‚

å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Capistrano éƒ¨ç½²ä»£ç ï¼Œé‚£ä¹ˆ

```
Code + ä¸åŒé…ç½® = ä¸åŒçš„éƒ¨ç½²(deploy)
```

å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Docker éƒ¨ç½²ï¼Œé‚£ä¹ˆï¼š

```
Docker Image + ä¸åŒé…ç½® = ä¸åŒçš„éƒ¨ç½²(deploy)ã€‚
```

å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Kubenetesï¼Œå°†ä¸åŒé…ç½®æ–‡ä»¶æ³¨å…¥åˆ°äº†Pod ä¸­ï¼Œå°±å˜æˆäº†ä¸åŒçš„éƒ¨ç½² (deploy)ã€‚

```yaml
---
apiVersion: v1
kind: Pod
metadata:
  labels:
    name: webapp
  name: webapp
  namespace: default
spec:
  containers:
  - name: web-app
    image: web-app:staging-1
    envFrom:
    - configMapRef:  ğŸ‘ˆ çœ‹è¿™é‡Œ
        name: staging-1-config-map
    - secretRef:     ğŸ‘ˆ çœ‹è¿™é‡Œ
        name: staging-1-secrets
```


### ä¼˜ç‚¹

åˆ›å»ºéƒ¨ç½²ï¼ˆdeployï¼‰ï¼Œåªéœ€è¦å‡†å¤‡ä¸€ä»½æ–°çš„é…ç½®æ–‡ä»¶å°±å¯ä»¥ï¼Œçœäº‹çœåŠ›ã€‚

è¿™ç§æ–¹æ¡ˆä¹Ÿä¿è¯äº†å®‰å…¨ã€‚ä»£ç ä¸­ä¸åŒ…å«æœºå¯†ä¿¡æ¯ï¼Œå³ä½¿ä»£ç æ³„éœ²ä¹Ÿä¸ä¼šæ‰©å¤§é£é™©ã€‚ä¸åŒéƒ¨ç½²(deploy) çš„é…ç½®æ–‡ä»¶å¯ä»¥è®¾ç½®ä¸åŒçš„è®¿é—®æƒé™ï¼Œæ¯”å¦‚ä»…ä»…å…è®¸ DevOps å›¢é˜Ÿè®¿é—® production deploy çš„é…ç½®ä¿¡æ¯ã€‚

åœ¨æœ¬æ–‡ä¸­æ‰€æœ‰éƒ¨ç½²(Deploy) çš„è¿è¡Œæ¨¡å¼éƒ½æ˜¯ production modeï¼Œä»¥æ­¤æ¶ˆé™¤äº†ä¸åŒéƒ¨ç½² (deploy) çš„å·®å¼‚ï¼ˆ[parity](https://12factor.net/dev-prod-parity)ï¼‰ã€‚


### ç¬¬äºŒç§æ–¹æ¡ˆçš„ç¼ºç‚¹

NewRelic, Datadog, Sentry ç­‰ç›‘æ§å·¥å…·é»˜è®¤ä¼šæŠŠ `Rails.env`å¹¶é™„ç€åœ¨æ—¥å¿—(log)ï¼Œå¼‚å¸¸ï¼ˆerror)ï¼Œæ€§èƒ½æ•°æ®ä¸Šï¼Œæ–¹ä¾¿è¿‡æ»¤ã€‚

![](/media/files/2022/2022-08-12_12-47-48.jpg)

ç¬¬äºŒç§æ–¹æ¡ˆä¸­ï¼Œæ‰€æœ‰çš„éƒ¨ç½²çš„è¿è¡Œæ¨¡å¼éƒ½ä¸º production modeï¼Œè¿™å¯¼è‡´ç›‘æ§å·¥å…·æŠŠæ‰€æœ‰æ•°æ®éƒ½æ··åœ¨ production mode ä¸‹ã€‚é‡åˆ°é—®é¢˜ï¼Œå·¥ç¨‹å¸ˆæ ¹æœ¬æ— æ³•åŒºåˆ†æ˜¯å“ªä¸ªéƒ¨ç½²å‡ºäº†é—®é¢˜ã€‚

![](/media/files/2022/2022-08-12_12-56-12-only-production.jpg)

## å¦‚ä½•è§£å†³ç›‘æ§å·¥å…·çš„é—®é¢˜ï¼Ÿ

å…¶å® NewRelic, Datadog, Sentry æä¾›äº†æ¥å£ï¼Œå…è®¸æˆ‘ä»¬è‡ªå®šä¹‰å®ä¾‹çš„åå­—ï¼Œä»¥ Sentry ä¸¾ä¾‹ï¼Œå®ƒçš„è¯­æ³•å¦‚ä¸‹ï¼š
 
 ```ruby
Sentry.init do |config|
  #...
  config.environment = "ä½ å–œæ¬¢çš„éƒ¨ç½²å"
end
```

å› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨staging-1, staging-2, staging-x, production ç­‰ä¸åŒéƒ¨ç½²ä¸­çš„é…ç½®ä¸­ï¼Œå¼•å…¥ä¸€ä¸ªæ–°çš„å˜é‡ "DEPLOYMENT_ID" æ¥å£°æ˜éƒ¨ç½²çš„åç§°ã€‚åˆå§‹åŒ–å„ç§ç›‘æ§å·¥å…·æ—¶ï¼Œè¯»å– ENV["DEPLOY_ID"] çš„å€¼ã€‚
 
å‡å¦‚ staging-1 çš„é…ç½®ä¿¡æ¯å¦‚ä¸‹ï¼š

```
DEPLOYMENT_ID=staging-1
DB_HOST=staging-1.db
DB_USER=postgres
...
```

æˆ‘ä»¬å¯ä»¥è¿™æ ·é…ç½® Sentryï¼š

```ruby
Sentry.init do |config|
  #...
  config.environment = ENV['DEPLOYMENT_ID'] # å®ƒçš„å€¼ä¸º staging-1
end
```

å¯ä»¥è¿™æ ·é…ç½® Datadogï¼š

```ruby
Datadog.configure do |c|
  # ...
  c.env = ENV['DEPLOYMENT_ID'] # å®ƒçš„å€¼ä¸º staging-1
end
```

è¿™æ ·å°±èƒ½ä¿è¯ç›‘æ§å·¥å…·çš„æ­£å¸¸æ˜¾ç¤ºäº†ã€‚

![](/media/files/2022/2022-08-12_20-35-02-deploy.md)


## è¿·æƒ‘çš„æ¦‚å¿µ

æˆ–è®¸å¾ˆå¤šäººè¯»å®Œæ–‡ç« ä¹‹åä¼šå¯¹ Deploy å’Œ Environment è¿™ä¸¤ä¸ªæ¦‚å¿µæ›´åŠ ç–‘æƒ‘ã€‚æˆ‘æƒ³ï¼Œè¿™ç§çš„å›°æƒ‘æ¥è‡ªäºå›ºæœ‰å°è±¡ï¼šæ¯ä¸ªåº”ç”¨ä»…æœ‰ä¸€ä¸ª production éƒ¨ç½²ã€‚

ç°å®ä¸–ç•Œå¹¶éå¦‚æ­¤ã€‚

**å¾ˆå¤š SaaS åº”ç”¨æ”¯æŒå¤§å®¢æˆ·çš„ç§æœ‰åŒ–éƒ¨ç½²**ã€‚åŒæ ·ä¸€å¥—ä»£ç ï¼Œä¼šå–ç»™ä¸­å›½ç”µä¿¡ï¼Œä¸­çŸ³æ²¹ï¼Œå…¬å®‰ç³»ç»Ÿã€‚ä»£ç éƒ¨ç½²åœ¨ä»–ä»¬å„è‡ªçš„ç§æœ‰äº‘ä¸Šï¼Œè¿è¡Œæ¨¡å¼éƒ½ä¸º production modeã€‚

**ä¸åŒå›½å®¶ä¹Ÿæœ‰ä¸åŒçš„æ•°æ®æ²»ç†ç­–ç•¥**ã€‚ä¸­å›½è¦æ±‚ Apple iCloud çš„æ•°æ®å¿…é¡»å­˜åœ¨äº‘ä¸Šè´µå·ã€‚iCloud åŒä¸€å¥—ä»£ç éƒ¨ç½²åœ¨ä¸­å›½å’Œç¾å›½ï¼Œå…¶è¿è¡Œæ¨¡å¼éƒ½ä¸º production modeã€‚æŠ–éŸ³åœ¨ç¾å›½éƒ¨ç½²åœ¨ Oracle Cloudä¸Šï¼Œåœ¨ä¸­å›½åˆ™éƒ¨ç½²åœ¨è‡ªå·±çš„æœºæˆ¿é‡Œï¼Œä»–ä»¬çš„è¿è¡Œæ¨¡å¼ä¹Ÿéƒ½ä¸º production modeã€‚

12-factor æå‡ºçš„éƒ¨ç½²ï¼ˆdeployï¼‰è¿™ä¸ªæ¦‚å¿µæ˜¯æ¯”ç¯å¢ƒï¼ˆEnvironmentï¼‰æ›´åŠ ç²¾ç¡®çš„æ¦‚å¿µã€‚

æ€»ç»“ä¸€ä¸‹ï¼š

- æŠŠ production / staging çœ‹åšè¿è¡Œæ¨¡å¼ã€‚
- æŠŠ staging-1, staging-2, staging-3, staging-4, staging-5, production çœ‹åšä»£ç çš„è¿è¡Œçš„å®ä¾‹ã€‚

![](/media/files/2022/2022-08-12-codebase-build-config-deploy.png)


## åè®°

æœ¬æ–‡ä»¥ Ruby on Rails ä¸ºç¤ºä¾‹ä»£ç ï¼Œä½†æ­¤æ–¹æ¡ˆå¹¶ä¸å±€é™äº Rails æ¡†æ¶ï¼Œä¹Ÿé€‚ç”¨äºåˆ°å…¶ä»–è¯­è¨€å’ŒWeb æ¡†æ¶ã€‚

æœ¬æ–‡ä¸­çš„æ–¹æ¡ˆï¼Œæ¥è‡ªäº Workstream åŒäº‹ä»¬çš„å®è·µç»éªŒï¼Œæˆ‘åªæ˜¯æç¬”è®°å½•ä¸‹æ¥ï¼Œå¹¶éæˆ‘çš„å·¥ä½œæˆæœã€‚

ç‰¹åˆ«æ„Ÿè°¢ Louise Xu, Felix Chen, Vincent Huang, Teddy Wang çš„å®¡æ ¡å’Œåé¦ˆã€‚

